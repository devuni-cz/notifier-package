name: Version Bump

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  bump:
    name: Bump to next ${{ github.event.inputs.version_type }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: current
        run: |
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Calculate new version
        id: new
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "${{ steps.current.outputs.version }}"
          case "${{ github.event.inputs.version_type }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac
          echo "version=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT
          echo "tag=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT
          echo "New version: v${MAJOR}.${MINOR}.${PATCH}"

      - name: Update CHANGELOG
        run: |
          VERSION="${{ steps.new.outputs.version }}"
          TODAY=$(date +%Y-%m-%d)

          # Insert new version section after [Unreleased] block
          sed -i "/^## \[Unreleased\]/a\\
          \\
          ## [${VERSION}] - ${TODAY}" CHANGELOG.md

          echo "Updated CHANGELOG.md with version ${VERSION}"

      - name: Commit, tag, and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.new.outputs.version }}"
          git tag "${{ steps.new.outputs.tag }}"
          git push origin main
          git push origin "${{ steps.new.outputs.tag }}"
